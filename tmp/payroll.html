<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Payroll Calculator</title>
        <script type="text/javascript">
            var handleDuplicate = function (event) {
                var tr = event.target.parentElement.parentElement.parentElement;
                var inputs = tr.getElementsByTagName("input");
                try {
                    var prevInputs = tr.previousElementSibling.getElementsByTagName("input");
                    for (var i = 0; i < 4; i ++) {
                        inputs[i].value = prevInputs[i].value;
                    }
                } catch (e) {
                    if (!(e instanceof TypeError)) {
                        throw e;
                    }
                }
            };

            function calculateTax(amount) {
                var ranks = [[0, 3, 0]
                    , [36000, 10, 2520]
                    , [144000, 20, 16920]
                    , [300000, 25, 31920]
                    , [420000, 30, 52920]
                    , [660000, 35, 85920]
                    , [960000, 45, 181920]
                ];
                var rate = 0,
                    delta = 0;
                for (var i = 0; i < ranks.length; i ++){
                    if (amount < ranks[i][0])
                        break;
                    rate = ranks[i][1];
                    delta = ranks[i][2];
                }
                return (amount * rate / 100.0 - delta).toFixed(2);
            }

            var handleCalculate = function(event) {
                var InputNOs = {
                    EarningsBeforeTax : 0,
                    DeductionsBeforeTax : 1,
                    AdditionalSpecialDeduction: 2,
                    DeductionsAfterTax: 3,
                    Grand: 4,
                    IIT : 5,
                    YearToDateGrand : 6,
                    YearToDateIIT : 7
                };

                var tr = event.target.parentElement.parentElement.parentElement;
                var inputs = tr.getElementsByTagName("input");
                var earnings = parseFloat(inputs[InputNOs.EarningsBeforeTax].value);
                var deductions = parseFloat(inputs[InputNOs.DeductionsBeforeTax].value);
                var asd = parseFloat(inputs[InputNOs.AdditionalSpecialDeduction].value);
                var deductions2 = parseFloat(inputs[InputNOs.DeductionsAfterTax].value);
                var y2dIit = -1,
                    y2dGrand = -1;
                try {
                    var prevInputs = tr.previousElementSibling.getElementsByTagName("input");
                    y2dGrand = parseFloat(prevInputs[InputNOs.YearToDateGrand].value);
                    y2dGrand = isNaN(y2dGrand) ? 0 : y2dGrand;
                    y2dIit = parseFloat(prevInputs[InputNOs.YearToDateIIT].value);
                    y2dIit = isNaN(y2dIit) ? 0 : y2dIit;
                } catch (e) {
                    if (e instanceof TypeError) {
                        y2dIit = 0;
                        y2dGrand = 0;
                    } else {
                        throw e;
                    }
                }

                var taxExemption = 5000;
                inputs[InputNOs.YearToDateGrand].value = earnings - taxExemption - deductions - asd + y2dGrand;
                inputs[InputNOs.YearToDateIIT].value = calculateTax(inputs[InputNOs.YearToDateGrand].value);
                inputs[InputNOs.IIT].value = (inputs[InputNOs.YearToDateIIT].value - y2dIit).toFixed(2);
                inputs[InputNOs.Grand].value = earnings - deductions - inputs[InputNOs.IIT].value - deductions2;
            };

            addHandler = function() {
                var buttons = document.getElementById("table").getElementsByTagName("button");
                for (var i = 0; i < buttons.length; i ++) {
                    if (buttons[i].name === "duplicate") {
                        buttons[i].addEventListener("click", handleDuplicate, false);
                    } else if (buttons[i].name === "calculate") {
                        buttons[i].addEventListener("click", handleCalculate, false);
                    }
                }
            };

            // window.onload = addHandler;
            window.addEventListener("load", addHandler, false);
        </script>
    </head>
    <body>
        <p id="p1"><b>Hello</b> world!</p>
        <input type="button" value="Use Ranges" onclick="useRanges()" />
        <table id="table" border="0">
            <tr>
                <td>
                    <fieldset>
                        <legend>January</legend>
                            Earnings Before Tax: <input type="text" title="" value="30000" />
                            <button name="duplicate">Duplicate</button><br />
                            Deductions Before Tax: <input type="text" title="" value="5000" /><br />
                            Additional Special Deduction: <input type="text" title="" value="2000" /><br />
                            Deductions After Tax: <input type="text" title="" value="1490" />
                            <button name="calculate">Calculate</button>
                    </fieldset>
                </td>
                <td>
                    <fieldset>
                        <legend>Result</legend>
                            Grand: <input type="text" title="" /><br />
                            IIT: <input type="text" title="" /><br />
                            Year To Date Grand: <input type="text" title="" /><br />
                            Year To Date IIT: <input type="text" title="" />
                    </fieldset>
                </td>
            </tr>
            <tr>
                <td>
                    <fieldset>
                        <legend>February</legend>
                        Earnings Before Tax: <input type="text" title="" value="0" />
                        <button name="duplicate">Duplicate</button><br />
                        Deductions Before Tax: <input type="text" title="" value="0" /><br />
                        Additional Special Deduction: <input type="text" title="" value="0" /><br />
                        Deductions After Tax: <input type="text" title="" value="0" />
                        <button name="calculate">Calculate</button>
                    </fieldset>
                </td>
                <td>
                    <fieldset>
                        <legend>Result</legend>
                        Grand: <input type="text" title="" /><br />
                        IIT: <input type="text" title="" /><br />
                        Year To Date Grand: <input type="text" title="" /><br />
                        Year To Date IIT: <input type="text" title="" />
                    </fieldset>
                </td>
            </tr>
            <tr>
                <td>
                    <fieldset>
                        <legend>March</legend>
                        Earnings Before Tax: <input type="text" title="" value="0" />
                        <button name="duplicate">Duplicate</button><br />
                        Deductions Before Tax: <input type="text" title="" value="0" /><br />
                        Additional Special Deduction: <input type="text" title="" value="0" /><br />
                        Deductions After Tax: <input type="text" title="" value="0" />
                        <button name="calculate">Calculate</button>
                    </fieldset>
                </td>
                <td>
                    <fieldset>
                        <legend>Result</legend>
                        Grand: <input type="text" title="" /><br />
                        IIT: <input type="text" title="" /><br />
                        Year To Date Grand: <input type="text" title="" /><br />
                        Year To Date IIT: <input type="text" title="" />
                    </fieldset>
                </td>
            </tr>
        </table>
        <p><strong>Note:</strong> This example uses DOM ranges and will only work in browsers that support DOM ranges. This example will fail in Internet Explorer &lt; 9.</p>
    </body>
</html>
